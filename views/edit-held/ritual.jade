mixin print(__data)
	p!=JSON.stringify(__data)

-	function getTalentID(__src, __name) {
-		if (!Array.isArray(__src)) {
-			return null;
-		}
-		__name = __name.toLowerCase().replace(/\s/g, '');
-		var talent = __src.filter(function(item) {
-			return item.name.toLowerCase().replace(/\s/g, '') === __name;
-		}).map(function(item) {
-			return item._id;
-		});
-		if (talent.length) {
-			return talent[0];
-		}
-		return null;
-	}

!!! 5
html(lang="de")
	head
		title Rituale hinzufügen
		link(rel="stylesheet", type="text/css", href="/show.css")
		link(rel="stylesheet", type="text/css", href="/nav-edit.css")
		script(src="/jquery-2.0.3.min.js")
		style.
			label[for] {
				cursor: pointer;
			}
			tfoot select {
				width: 50%;
			}
			#tbl-tmpl {
				display: none;
			}
			tfoot tr {
				background-color: #eee;
			}
	body
		a#top
		nav
			a(href="#top") [Seitenanfang]
			a(href="#save") [speichern]
			a(href="/magie/"+_id, title="Magiebogen")= "⇒ "+Person.Name.split(' ')[0]
		
		h1.mitte
			a(href="/held/"+_id, title="Heldenbogen")= Person.Name
		
		form(action="/ritual/"+_id, method="post", accept-charset="utf-8")
			input(type="hidden", name="_method", value="put")
			
			a#ritualkenntnis
			section
				table.data-section.eigenschaften.mitte#tbl-rk
					caption Ritualkenntnis
					colgroup
						col(style="width: 2em;")
						col
						col
						col(span="2", style="width: 10em;")
					thead
						tr
							td
							th Ritualkenntnis
							th Tradition
							th Lernstufe
							th RkW
					tfoot
						tr
							td
							td.links
								select#rk(size="1", title="Allgemeine Ritualkenntnisse")
									optgroup(label="Allgemeine RK")
										each __long, __short in _data.Ritualkenntnis
											if typeof __long === "string"
												option(data-long=__long, data-short=__short)=__long
							td
							td(colspan="2")
								button#addrk(type="button") neue Ritualkenntnis
						tr
							td
							td.links Zaubertänzer
							td
								select#rkz(size="1", title="Zaubertänzer")
									optgroup(label="Zaubertänzer")
										each __long, __short in _data.Ritualkenntnis.Zaubertänzer
											option(data-long="Zaubertänzer", data-short="Ztz", data-rep-short=__short, data-rep-long=__long)=__long
							td(colspan="2")
								button#addrkz(type="button") neue Ritualkenntnis
						tr
							td
							td.links Schamane
							td
								select#rks(size="1", title="Schamanen")
									optgroup(label="Schamanen")
										each __long, __short in _data.Ritualkenntnis.Schamane
											option(data-long="Schamane", data-short="Shm", data-rep-short=__short, data-rep-long=__long)=__long
							td(colspan="2")
								button#addrks(type="button") neue Ritualkenntnis
					tbody
						if Array.isArray(Magie.Ritualkenntnis)
							each __rk, __idx in Magie.Ritualkenntnis
								case __rk.short
									when "Ztz"
										tr
											td(style="padding: 0;")
												input.isactive(type="checkbox", id="zt_"+__idx, checked)
												input.unlock(type="hidden", name="Magie.Ritualkenntnis[#{__idx}][short]", value="Ztz")
												input.unlock(type="hidden", name="Magie.Ritualkenntnis[#{__idx}][long]", value=__rk.long)
												input.unlock(type="hidden", name="Magie.Ritualkenntnis[#{__idx}][tradition]", value=__rk.tradition)
											td.links
												label.links(for="zt_"+__idx) Zaubertänzer
											td
												label(for="zt_"+__idx)=__rk.long
											td
												select.unlock(size="1", name="Magie.Ritualkenntnis[#{__idx}][Lernstufe]")
													each kat in ["A+", "A", "B", "C", "D", "E", "F", "G", "H"]
														option(selected=(__rk.Lernstufe === kat))= kat
											td
												input.unlock.mitte(type="number", name="Magie.Ritualkenntnis[#{__idx}][RkW]", min="3", max="35", step="1", value=__rk.RkW)
									when "Shm"
										tr
											td(style="padding: 0;")
												input.isactive(type="checkbox", id="sr_"+__idx, checked)
												input.unlock(type="hidden", name="Magie.Ritualkenntnis[#{__idx}][_talent]", value=__rk._talent._id)
												input.unlock(type="hidden", name="Magie.Ritualkenntnis[#{__idx}][short]", value="Shm")
												input.unlock(type="hidden", name="Magie.Ritualkenntnis[#{__idx}][long]", value=__rk.long)
												input.unlock(type="hidden", name="Magie.Ritualkenntnis[#{__idx}][tradition]", value=__rk.tradition)
											td.links
												label(for="sr_"+__idx)=__rk._talent.name
											td
												label(for="sr_"+__idx)=__rk.long
											td
												select.unlock(size="1", name="Magie.Ritualkenntnis[#{__idx}][Lernstufe]")
													each kat in ["A+", "A", "B", "C", "D", "E", "F", "G", "H"]
														option(selected=(__rk.Lernstufe === kat))= kat
											td
												input.unlock.mitte(type="number", name="Magie.Ritualkenntnis[#{__idx}][RkW]", min="3", max="35", step="1", value=__rk.RkW)
									default
										tr
											td(style="padding: 0;")
												input.isactive(type="checkbox", id="rk_"+__idx, checked)
												input.unlock(type="hidden", name="Magie.Ritualkenntnis[#{__idx}][short]", value=__rk.short)
												input.unlock(type="hidden", name="Magie.Ritualkenntnis[#{__idx}][long]", value=__rk.long)
											td.links
												label(for="rk_"+__idx)=__rk.long
											td
											td
												select.unlock(size="1", name="Magie.Ritualkenntnis[#{__idx}][Lernstufe]")
													each kat in ["A+", "A", "B", "C", "D", "E", "F", "G", "H"]
														option(selected=(__rk.Lernstufe === kat))= kat
											td
												input.unlock.mitte(type="number", name="Magie.Ritualkenntnis[#{__idx}][RkW]", min="3", max="35", step="1", value=__rk.RkW)
			section#save
				.mitte
					button(type="submit") speichern
		
		table#tbl-tmpl
			tbody#tmpl-allg
				tr
					td(style="padding: 0;")
						input.isactive(type="checkbox", id="rk_{index}", checked)
						input.unlock(type="hidden", name="Magie.Ritualkenntnis[{index}][short]").short
						input.unlock(type="hidden", name="Magie.Ritualkenntnis[{index}][long]").long
					td.links
						label(for="rk_{index}")
					td
					td
						select.unlock(size="1", name="Magie.Ritualkenntnis[{index}][Lernstufe]")
							each kat in ["A+", "A", "B", "C", "D", "E", "F", "G", "H"]
								option= kat
					td
						input.unlock.mitte(type="number", name="Magie.Ritualkenntnis[{index}][RkW]", min="3", max="35", step="1", value="3")
			tbody#tmpl-tanz
				tr
					td(style="padding: 0;")
						input.isactive(type="checkbox", id="zt_{index}", checked)
						input.unlock(type="hidden", name="Magie.Ritualkenntnis[{index}][short]", value="Ztz")
						input.unlock(type="hidden", name="Magie.Ritualkenntnis[{index}][long]").long
						input.unlock(type="hidden", name="Magie.Ritualkenntnis[{index}][tradition]").short
					td.links
						label.links(for="zt_{index}") Zaubertänzer
					td
						label(for="zt_{index}").long
					td
						select.unlock(size="1", name="Magie.Ritualkenntnis[{index}][Lernstufe]")
							each kat in ["A+", "A", "B", "C", "D", "E", "F", "G", "H"]
								option= kat
					td
						input.unlock.mitte(type="number", name="Magie.Ritualkenntnis[{index}][RkW]", min="3", max="35", step="1", value="3")
			tbody#tmpl-schm
				tr
					td(style="padding: 0;")
						input.isactive(type="checkbox", id="sr_{index}", checked)
						input.unlock(type="hidden", name="Magie.Ritualkenntnis[{index}][_talent]", value=getTalentID(_talente, "Geister binden"))
						input.unlock(type="hidden", name="Magie.Ritualkenntnis[{index}][short]", value="Shm")
						input.unlock(type="hidden", name="Magie.Ritualkenntnis[{index}][long]").long
						input.unlock(type="hidden", name="Magie.Ritualkenntnis[{index}][tradition]").short
					td.links
						label(for="sr_{index}") Geister binden
					td
						label(for="sr_{index}").long
					td
						select.unlock(size="1", name="Magie.Ritualkenntnis[{index}][Lernstufe]")
							each kat in ["A+", "A", "B", "C", "D", "E", "F", "G", "H"]
								option= kat
					td
						input.unlock.mitte(type="number", name="Magie.Ritualkenntnis[{index}][RkW]", min="3", max="35", step="1", value="3")
				tr
					td(style="padding: 0;")
						input.isactive(type="checkbox", id="sr_{index}", checked)
						input.unlock(type="hidden", name="Magie.Ritualkenntnis[{index}][_talent]", value=getTalentID(_talente, "Geister rufen"))
						input.unlock(type="hidden", name="Magie.Ritualkenntnis[{index}][short]", value="Shm")
						input.unlock(type="hidden", name="Magie.Ritualkenntnis[{index}][long]").long
						input.unlock(type="hidden", name="Magie.Ritualkenntnis[{index}][tradition]").short
					td.links
						label(for="sr_{index}") Geister rufen
					td 
						label(for="sr_{index}").long
					td
						select.unlock(size="1", name="Magie.Ritualkenntnis[{index}][Lernstufe]")
							each kat in ["A+", "A", "B", "C", "D", "E", "F", "G", "H"]
								option= kat
					td
						input.unlock.mitte(type="number", name="Magie.Ritualkenntnis[{index}][RkW]", min="3", max="35", step="1", value="3")
				tr
					td(style="padding: 0;")
						input.isactive(type="checkbox", id="sr_{index}", checked)
						input.unlock(type="hidden", name="Magie.Ritualkenntnis[{index}][_talent]", value=getTalentID(_talente, "Geister bannen"))
						input.unlock(type="hidden", name="Magie.Ritualkenntnis[{index}][short]", value="Shm")
						input.unlock(type="hidden", name="Magie.Ritualkenntnis[{index}][long]").long
						input.unlock(type="hidden", name="Magie.Ritualkenntnis[{index}][tradition]").short
					td.links
						label(for="sr_{index}") Geister bannen
					td 
						label(for="sr_{index}").long
					td
						select.unlock(size="1", name="Magie.Ritualkenntnis[{index}][Lernstufe]")
							each kat in ["A+", "A", "B", "C", "D", "E", "F", "G", "H"]
								option= kat
					td
						input.unlock.mitte(type="number", name="Magie.Ritualkenntnis[{index}][RkW]", min="3", max="35", step="1", value="3")
				tr
					td(style="padding: 0;")
						input.isactive(type="checkbox", id="sr_{index}", checked)
						input.unlock(type="hidden", name="Magie.Ritualkenntnis[{index}][_talent]", value=getTalentID(_talente, "Geister aufnehmen"))
						input.unlock(type="hidden", name="Magie.Ritualkenntnis[{index}][short]", value="Shm")
						input.unlock(type="hidden", name="Magie.Ritualkenntnis[{index}][long]").long
						input.unlock(type="hidden", name="Magie.Ritualkenntnis[{index}][tradition]").short
					td.links
						label(for="sr_{index}") Geister aufnehmen
					td 
						label(for="sr_{index}").long
					td
						select.unlock(size="1", name="Magie.Ritualkenntnis[{index}][Lernstufe]")
							each kat in ["A+", "A", "B", "C", "D", "E", "F", "G", "H"]
								option= kat
					td
						input.unlock.mitte(type="number", name="Magie.Ritualkenntnis[{index}][RkW]", min="3", max="35", step="1", value="3")
		script.
			// activate/deactivate entries
			$('#tbl-rk').on("click", "input.isactive", function(evt) {
				var $row = $(this).closest('tr');
				$row.find("*[name]").prop("disabled", !this.checked);
				if (this.checked) {
					$row.removeClass("disabled");
				}
				else {
					$row.addClass("disabled");
				}
			});
			function reIndex($obj, index) {
				$obj.find('.unlock').each(function() {
					this.name = this.name.replace('{index}', index);
				});
				$obj.find('label').each(function() {
					this.htmlFor = this.htmlFor.replace('{index}', index);
				});
				var rkid = $obj.find('input[type="checkbox"]')[0];
				rkid.id  = rkid.id.replace('{index}', index);
				// default dropdown to "E"
				$obj.find('select').val('E');
			}
			$('#addrk').on("click", function() {
				var $src = $('#rk option').filter(':selected');
				var $row = $('#tmpl-allg tr').clone();
				var idx  = $('#tbl-rk tbody tr').length;
				reIndex($row, idx);
				$row.find('label').text($src.data("long"));
				// set values
				$row.find('.short').val($src.data("short"));
				$row.find('.long').val($src.data("long"));
				// append
				$('#tbl-rk').append($row);
				$src.remove();
			});
			$('#addrkz').on("click", function() {
				var $src = $('#rkz option').filter(':selected');
				var $row = $('#tmpl-tanz tr').clone();
				var idx  = $('#tbl-rk tbody tr').length;
				reIndex($row, idx);
				// set values
				$row.find('.short').val($src.data("rep-short"));
				$row.find('input.long').val($src.data("rep-long"));
				$row.find('label.long').text($src.data("rep-long"));
				// append
				$('#tbl-rk').append($row);
				$src.remove();
			});
			$('#addrks').on("click", function() {
				var $src  = $('#rks option').filter(':selected');
				var $rows = $('#tmpl-schm tr');
				$('#tmpl-schm tr').each(function() {
					var idx  = $('#tbl-rk tbody tr').length;
					var $row = $(this).clone();
					reIndex($row, idx);
					// set values
					$row.find('.short').val($src.data("rep-short"));
					$row.find('input.long').val( $src.data("rep-long") + "-Schamane");
					$row.find('label.long').text($src.data("rep-long") + "-Schamane");
					// append
					$('#tbl-rk').append($row);
				});
				$src.remove();
			});
			/*$("form").on("submit", function() {
				$('.isactive:not(:checked)').each(function() {
					$(this).closest('tr').find('select, input').prop('disabled', true);
				});
			});//*/
